{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Social District Clothing{% endblock %}</title>
    <link rel="icon" href="{% static 'images/SDC no Text.png' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="{% static 'styles/styles.css' %}">
</head>
<body>
    <nav class="navbar navbar-expand-lg border-bottom shadow-sm sticky-top">
        <div class="container-fluid mx-5 fs-5 fw-semibold">
          <a class="navbar-brand" href="{% url "home" %}">
            <img class="sdcLogo" src="{% static 'images/SDC no Text.png' %}" alt="Logo">SOCIAL DISTRICT CLOTHING
          </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
              <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarNavDropdown">
              <ul class="navbar-nav ms-auto d-flex align-items-center">
                <li class="nav-item">
                    <a class="nav-link" aria-current="page" href="{% url "aboutus" %}">About Us</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{% url "product" %}">Product</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{% url "contacts" %}">Contacts</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{% url "faq" %}">FAQ</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="#" data-bs-toggle="offcanvas" data-bs-target="#cartSidebar" aria-controls="cartSidebar">
                    <div>
                      <div class="itemCountCart text-center ">{{ total_item_count }}</div>
                      <img class="cartImg" src="{% static 'images/cart.svg' %}" alt="cart">
                    </div>
                  </a>
                </li>
              </ul>
          </div>
        </div>
    </nav>

    
    {% block content %} {% endblock %} 

    <footer class="">
      <div class="marquee py-2">
        <h2>
          <a href="{% url "home" %}" class="marquee-link mx-3 fw-bold">SOCIAL DISTRICT CLOTHING</a>
          <a href="{% url "home" %}" class="marquee-link mx-3 fw-bold">SOCIAL DISTRICT CLOTHING</a>
          <a href="{% url "home" %}" class="marquee-link mx-3 fw-bold">SOCIAL DISTRICT CLOTHING</a>
          <a href="{% url "home" %}" class="marquee-link mx-3 fw-bold">SOCIAL DISTRICT CLOTHING</a>
          <a href="{% url "home" %}" class="marquee-link mx-3 fw-bold">SOCIAL DISTRICT CLOTHING</a>
          <a href="{% url "home" %}" class="marquee-link mx-3 fw-bold">SOCIAL DISTRICT CLOTHING</a>
          <a href="{% url "home" %}" class="marquee-link mx-3 fw-bold">SOCIAL DISTRICT CLOTHING</a>
          <a href="{% url "home" %}" class="marquee-link mx-3 fw-bold">SOCIAL DISTRICT CLOTHING</a>
          <a href="{% url "home" %}" class="marquee-link mx-3 fw-bold">SOCIAL DISTRICT CLOTHING</a>
          <a href="{% url "home" %}" class="marquee-link mx-3 fw-bold">SOCIAL DISTRICT CLOTHING</a>
        </h2>
      </div>
      <div class="p-2">
    
        <div class="info mx-5">
          <div class="logo">
            <img src="{% static 'images/SDC no Text.png' %}" alt="Logo" class="mx-auto d-flex">
            <p>2025 Social District Clothing!</p>
          </div>
          <div class="companyInfo-Section">
            <div class="socialMedia-Text">
              <h3 class="fw-bold">STAY UPDATED</h3>
              <p class="fw-semibold">Like, Follow to receive updates.</p>
            </div>
            <div class="companyInfo-Section fw-semibold">
              <a href="https://www.facebook.com/SocialdistrictclothingPH" target="blank" class="text-secondary-emphasis text-decoration-none hover-white" ><img class="footerLogo" src="{% static 'images/fbSVG.svg' %}" alt="Facebook"></a>
              {% comment %} <a href="https://shopee.ph/socialdistrictclothing2022?smtt=0.498832252-1660296740.9" target="blank" class="text-secondary-emphasis text-decoration-none hover-white"><img class="footerLogo" src="{% static 'images/shopeeSVG.svg' %}" alt="Shopee"></a> {% endcomment %}
              <a href="https://www.tiktok.com/@socialdistrictclothing?_r=1&_d=secCgYIASAHKAESPgo8V29RLpVXK9ODFtDL%2FWe6Cz9aV5gPtRVlYFRL8BlP4LufpqJgyRc9nwY934QNUSW5NqL%2F%2BtIAwFJvijvEGgA%3D&_svg=1&checksum=8ef8520b440555a092b5433a6879cf5ca467ea92e2e81f418d98bba04e8db0a8&sec_uid=MS4wLjABAAAA8eSuiWpXmUYcJfYmnRoQV5qx0RKQWKueji6GhsYOjWEW4pl48mGu5kr22O0J4Vdl&sec_user_id=MS4wLjABAAAA8eSuiWpXmUYcJfYmnRoQV5qx0RKQWKueji6GhsYOjWEW4pl48mGu5kr22O0J4Vdl&share_app_id=1180&share_author_id=7065972961509934081&share_link_id=B33B1020-C024-47DD-8ABB-769EA4DA31DA&sharer_language=en&social_share_type=4&source=h5_t&timestamp=1746289367&tt_from=copy&u_code=e09la83akgbg0l&ug_btm=b8727%2Cb0&user_id=7065972961509934081"
              target="blank" class="text-secondary-emphasis text-decoration-none hover-white"><img class="footerLogo" src="{% static 'images/tiktokSVG.svg' %}" alt="Tiktok"></a>
            </div>
          </div>
        </div>
      </div>
    </footer>

    <div class="offcanvas offcanvas-end" tabindex="-1" id="cartSidebar" aria-labelledby="cartSidebarLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="cartSidebarLabel">Your Cart</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>

      <div class="offcanvas-body" id="cartItemsContainer">
        {% if cart_items %}
          {% for item in cart_items %}
          <div class="container d-flex align-items-start mb-3 border-bottom pb-2">
            
            <!-- Image Column -->
            <div class="container-fluid me-3" style="max-width: 100px;">
              <img src="{{ item.image_url }}" 
                  class="img-fluid rounded shadow" 
                  style="width: 100%; height: 100%; object-fit: cover;" 
                  alt="{{ item.product_name }} image">
            </div>

            <!-- Info Column -->
            <div class="container-fluid">
              <strong>{{ item.product_name }}</strong><br>
              Size: {{ item.size }}<br>
              Color: {{ item.color }}<br>

            <!-- Quantity Update Form -->
            <form method="POST" 
                  action="{% url 'update_cart_quantity' item.product_id item.size %}" 
                  class="d-flex align-items-center mt-2">
              {% csrf_token %}
              
              <!-- Minus Button -->
              <button type="button" class="btn btn-outline-secondary btn-sm me-1" onclick="changeQuantity(this, -1)">−</button>
              
              <!-- Quantity Input -->
              <input class="quantityUpdate text-center" type="number" 
                    name="quantity" 
                    value="{{ item.quantity }}" 
                    min="1" 
                    class="form-control form-control-sm text-center me-1" 
                    style="width: 30px;"
                    onchange="this.form.submit()">

              <!-- Plus Button -->
              <button type="button" class="btn btn-outline-secondary btn-sm ms-1" onclick="changeQuantity(this, 1)">+</button>
            </form>
              <span class="d-block mt-2">
                Price: ₱{{ item.price }}<br>
                Subtotal: <strong class="text-success">₱{{ item.subtotal }}</strong>
              </span>

              <!-- Remove Button -->
              <form method="POST" action="{% url 'remove_from_cart' item.product_id item.size %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger btn-sm mt-2">
                  <img src="{% static 'images/trashcanSVG.svg' %}" alt="DELETE" style="width: 20px;">
                </button>
              </form>
            </div>
          </div>
          {% endfor %}

          <!-- Total -->
          <div class="border-top pt-3 mt-3 text-end">
            <h5>Total: <span class="text-success">₱{{ total_price }}</span></h5>
            <a href="{% url 'checkout' %}" class="btn btn-success w-100 mt-3">Proceed to Checkout</a>
          </div>
        {% else %}
          <p>Your cart is empty.</p>
        {% endif %}
      </div>
    </div>

    <!-- Add to Cart / Buy Now Modal -->
    <div class="modal fade" id="addToCartModal" tabindex="-1" aria-labelledby="addToCartModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <form id="addToCartFormBestSeller" method="POST" action="{% url 'add_to_cart' %}">
          {% csrf_token %}
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="addToCartModalLabel">Add to Cart</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <img id="modalProductImage" src="" alt="Product Image" class="img-fluid mb-3" />
              <input type="hidden" name="productID" id="modalProductID" value="" />

              <div class="mb-3">
                <label for="modalSizeID" class="form-label">Select Size</label>
                <select class="form-select" id="modalSizeID" name="sizeID" required>
                  <!-- Sizes will be populated dynamically -->
                </select>
              </div>

              <div class="mb-3">
                <label for="modalQuantity" class="form-label">Quantity</label>
                <input type="number" min="1" value="1" class="form-control" id="modalQuantity" name="quantity" required />
              </div>
            </div>
            <div class="modal-footer">
              <button type="submit" id="modalSubmitBtn" class="btn btn-success">Add to Cart</button>
            </div>
          </div>
        </form>
      </div>
    </div>


<script>
  // --- Utility: Get CSRF Token ---
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');
</script>

<script>
  // --- Modal Logic: Populate and Submit ---
  function openAddToCartModal(data) {
    document.getElementById('modalProductID').value = data.productID;

    // Populate size dropdown
    const sizeSelect = document.getElementById('modalSizeID');
    sizeSelect.innerHTML = '';
    data.sizes.forEach(size => {
      const option = document.createElement('option');
      option.value = size.id;
      option.text = size.label;
      sizeSelect.appendChild(option);
    });

    // Set product image and reset quantity
    document.getElementById('modalProductImage').src = data.imageURL;
    document.getElementById('modalQuantity').value = 1;

    // Reset Buy Now state
    const form = document.getElementById('addToCartFormBestSeller');
    form.dataset.buyNow = 'false';
    document.getElementById('modalSubmitBtn').textContent = 'Add to Cart';
  }

  function openBuyNowModal(data) {
    openAddToCartModal(data);
    const form = document.getElementById('addToCartFormBestSeller');
    form.dataset.buyNow = 'true';
    document.getElementById('modalSubmitBtn').textContent = 'Buy Now';
  }

  document.getElementById('addToCartModal').addEventListener('hidden.bs.modal', () => {
    const form = document.getElementById('addToCartFormBestSeller');
    form.dataset.buyNow = 'false';
    document.getElementById('modalSubmitBtn').textContent = 'Add to Cart';
  });

  document.getElementById('addToCartFormBestSeller').addEventListener('submit', function (event) {
    event.preventDefault();

    const form = this;
    const formData = new FormData(form);
    const isBuyNow = form.dataset.buyNow === 'true';

    fetch(form.action, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('addToCartModal'));
        modal.hide();

        // Update cart badge
        const cartCount = document.getElementById('cartItemCount');
        if (cartCount) {
          cartCount.textContent = data.total_item_count;
        }

        if (isBuyNow) {
          window.location.href = "{% url 'checkout' %}";
        } else {
          alert("Item added to cart!");
        }
      } else {
        alert("Failed: " + (data.error || 'Unknown error'));
      }
    })
    .catch(() => alert("Something went wrong."));
  });
</script>

<script>
  // --- Quick Add to Cart Buttons (No modal) ---
  document.addEventListener('DOMContentLoaded', () => {
    const buttons = document.querySelectorAll('.ajax-add-to-cart');

    buttons.forEach(btn => {
      btn.addEventListener('click', function (event) {
        event.preventDefault();

        const payload = new FormData();
        payload.append('productID', this.dataset.productId);
        payload.append('sizeID', this.dataset.sizeId);
        payload.append('quantity', this.dataset.quantity || 1);

        fetch("{% url 'add_to_cart' %}", {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: payload
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            const cartCount = document.getElementById('cartItemCount');
            if (cartCount) {
              cartCount.textContent = data.total_item_count;
            }
            alert("Item added to cart!");
          } else {
            alert("Error: " + (data.error || 'Unable to add'));
          }
        })
        .catch(() => alert("Network error"));
      });
    });
  });
</script>

<script>
  // --- Toasts (for success messages etc.) ---
  document.addEventListener('DOMContentLoaded', () => {
    const toasts = document.querySelectorAll('.toast');
    toasts.forEach(toast => new bootstrap.Toast(toast, { delay: 4000 }).show());
  });

  // --- Quantity Increment/Decrement Utility ---
  function changeQuantity(button, change) {
    const input = button.parentNode.querySelector('input[name="quantity"]');
    let currentValue = parseInt(input.value) || 1;
    let newValue = currentValue + change;
    if (newValue < 1) newValue = 1; // prevent going below 1
    input.value = newValue;
    input.form.submit(); // this reloads the page with updated quantity
  }

</script>

<!-- Google Map (only loads if map is visible) -->
<script>
  function initMap() {
    const location = { lat: 14.606, lng: 120.9736 };
    const map = new google.maps.Map(document.getElementById("map"), {
      zoom: 14,
      center: location,
    });

    new google.maps.Marker({
      position: location,
      map: map,
      title: "We are here!",
    });
  }
</script>
<script async
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD7vHyAIqo-jgZC82kJMrZ79Wks-Tg6PTg&callback=initMap">
</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

</body>
</html>