{% extends 'base.html' %}
{% load static %}
{% block title %}{{ product.productname }}{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Product Title -->
    <div class="row mb-4">
        <div class="col text-center">
            <h1 class="display-5 fw-bold">{{ product.productname }}</h1>
        </div>
    </div>

    <!-- Product Details -->
    <form method="post" id="addToCartForm" action="{% url 'add_to_cart' %}">

        {% csrf_token %}
        <div class="row g-5">
            <!-- Product Image -->
            <div class="col-md-6 text-center">
                <img id="mainProductImage"
                     src="{{ product.productimage }}"
                     alt="Product Image"
                     class="img-fluid rounded shadow"
                     style="max-width: 100%; height: auto;">
            </div>

            <!-- Options and Purchase -->
            <div class="col-md-6">
                <h3 class="text-success mb-4">Price: PHP {{ price }}</h3>

                <!-- Quantity -->
                <div class="mb-4">
                    <label for="quantity" class="form-label">Quantity</label>
                    <input type="number" name="quantity" id="quantity" min="1" value="1" class="form-control" required>
                </div>

                <!-- Size Options -->
                <div class="mb-4">
                    <h5>Available Sizes</h5>
                    <div class="row g-2">
                        {% for size in size_variants %}
                            <div class="col-6 col-sm-4">
                                <label class="btn btn-outline-primary w-100">
                                    <input type="radio"
                                           name="sizeID"
                                           value="{{ size.sizeid }}"
                                           class="d-none"
                                           required>
                                    {{ size.size }}
                                </label>
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Color Options -->
                <div class="mb-4">
                    <h5>Available Colors</h5>
                    <div class="row g-2">
                        {% for variant in color_variants_data %}
                            <div class="col-6 col-sm-4">
                                <label class="btn btn-outline-secondary w-100">
                                    <input type="radio"
                                           name="productID"
                                           value="{{ variant.id }}"
                                           data-image="{{ variant.image }}"
                                           class="d-none"
                                           {% if forloop.first %}checked{% endif %}>
                                    <img src="{{ variant.image }}"
                                         alt="{{ variant.color }} Image"
                                         class="img-fluid rounded">
                                </label>
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Hidden Inputs -->
                <input type="hidden" name="imageURL" id="selectedImageURL" value="{{ product.productimage }}">
                <input type="hidden" id="selectedProductID" value="{{ product.productid }}">

                <!-- Submit -->
                <button type="submit" class="btn btn-success w-100 mt-3">Add to Cart</button>
            </div>
        </div>
    </form>
</div>

<!-- JavaScript -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const productRadios = document.querySelectorAll('input[name="productID"]');
        const sizeRadios = document.querySelectorAll('input[name="sizeID"]');
        const hiddenImage = document.getElementById('selectedImageURL');
        const hiddenProduct = document.getElementById('selectedProductID');
        const mainImage = document.getElementById('mainProductImage');

        function updateActive(radioGroup) {
            radioGroup.forEach(r => r.closest('label').classList.remove('active'));
            const selected = document.querySelector(`input[name="${radioGroup[0].name}"]:checked`);
            if (selected) {
                selected.closest('label').classList.add('active');
            }
        }

        function updateVariantSelection() {
            const selectedColor = document.querySelector('input[name="colorID"]:checked');
            if (selectedColor) {
                const newImage = selectedColor.dataset.image;
                const newProductId = selectedColor.dataset.product;

                hiddenImage.value = newImage;
                hiddenProduct.value = newProductId;
                mainImage.src = newImage;

                // ⚠️ Update form action with correct productID
                document.getElementById('addToCartForm').action = `/add-to-cart/${newProductId}/`;
            }
        }

        // Initial state setup
        if (productRadios.length) {
            updateActive(productRadios);
            updateVariantSelection();
        }
        if (sizeRadios.length) updateActive(sizeRadios);

        // Event listeners
        productRadios.forEach(radio => {
            radio.addEventListener('change', () => {
                updateActive(productRadios);
                updateVariantSelection();
            });
        });

        sizeRadios.forEach(radio => {
            radio.addEventListener('change', () => updateActive(sizeRadios));
        });
    });
</script>
{% endblock %}
