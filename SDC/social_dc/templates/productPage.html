{% extends 'base.html' %}
{% load static %}
{% block title %}{{ product.productname }}{% endblock %}

{% block content %}
{% include 'includes/toast.html' %}

<div class="container py-5">
    <!-- Product Title -->
    <div class="row mb-4">
        <div class="col text-center">
            <h1 class="display-5 fw-bold">{{ product.productname }}</h1>
        </div>
    </div>

    <!-- Product Details -->
    <form method="post" id="addToCartForm" action="{% url 'add_to_cart' %}">

        {% csrf_token %}
        <div class="row g-5">
            <!-- Product Image -->
            <div class="col-md-6 text-center">
                <img id="mainProductImage"
                     src="{{ product.productimage }}"
                     alt="Product Image"
                     class="img-fluid rounded shadow"
                     style="max-width: 100%; height: auto;">
            </div>

            <!-- Options and Purchase -->
            <div class="col-md-6">
                <h3 class="text-success mb-4">Price: PHP {{ price }}</h3>

                <!-- Quantity -->
                <div class="mb-4">
                    <label for="quantity" class="form-label">Quantity</label>
                    <input type="number" name="quantity" id="quantity" min="1" max="50" value="1" class="form-control" required>
                </div>

                <!-- Size Options -->
                <div class="mb-4">
                    <h5>Available Sizes</h5>
                    <div class="row g-2">
                        {% for size in size_variants %}
                            <div class="col-6 col-sm-4">
                                <label class="btn btn-outline-primary w-100">
                                    <input type="radio"
                                           name="sizeID"
                                           value="{{ size.sizeid }}"
                                           class="d-none"
                                           required>
                                    {{ size.size }}
                                </label>
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Color Options -->
                <div class="mb-4">
                    <h5>Available Colors</h5>
                    <div class="row g-2">
                        {% for variant in color_variants_data %}
                            <div class="col-6 col-sm-4">
                                <label class="btn btn-outline-secondary w-100">
                                    <input type="radio"
                                           name="productID"
                                           value="{{ variant.id }}"
                                           data-image="{{ variant.image }}"
                                           class="d-none"
                                           {% if forloop.first %}checked{% endif %}>
                                    <img src="{{ variant.image }}"
                                         alt="{{ variant.color }} Image"
                                         class="img-fluid rounded">
                                </label>
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Hidden Inputs -->
                <input type="hidden" name="imageURL" id="selectedImageURL" value="{{ product.productimage }}">
                <input type="hidden" id="selectedProductID" value="{{ product.productid }}">

                <!-- Submit -->
                <button type="submit" class="btn btn-success w-100 mt-3" id="submitBtn" disabled>Add to Cart</button>
            </div>
        </div>
    </form>
</div>

<!-- JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('addToCartForm');
    const productRadios = form.querySelectorAll('input[name="productID"]');
    const sizeRadios = form.querySelectorAll('input[name="sizeID"]');
    const submitBtn = document.getElementById('submitBtn');
    const hiddenImage = document.getElementById('selectedImageURL');
    const hiddenProduct = document.getElementById('selectedProductID');
    const mainImage = document.getElementById('mainProductImage');
    const quantityInput = document.getElementById('quantity');

    // Validate quantity input
    quantityInput.addEventListener('input', function() {
        let value = parseInt(this.value);
        
        // Prevent negative values
        if (value < 1 || isNaN(value)) {
            this.value = 1;
        }
        
        // Prevent values over 50
        if (value > 50) {
            this.value = 50;
        }
    });

    // Validate on blur (when user leaves the field)
    quantityInput.addEventListener('blur', function() {
        if (this.value === '' || parseInt(this.value) < 1) {
            this.value = 1;
        }
        if (parseInt(this.value) > 50) {
            this.value = 50;
        }
    });

    // ðŸ§  Activate label styling
    function updateActive(radioGroup) {
        radioGroup.forEach(r => r.closest('label').classList.remove('active'));
        const selected = form.querySelector(`input[name="${radioGroup[0].name}"]:checked`);
        if (selected) {
            selected.closest('label').classList.add('active');
        }
    }

    // ðŸ§  Update hidden inputs and main image
    function updateVariantSelection() {
        const selectedColor = form.querySelector('input[name="productID"]:checked');
        if (selectedColor) {
            const newImage = selectedColor.dataset.image;
            const newProductId = selectedColor.value;

            hiddenImage.value = newImage;
            hiddenProduct.value = newProductId;
            mainImage.src = newImage;

            {% comment %} form.action = `/add-to-cart/${newProductId}/`; {% endcomment %}
        }
    }

    // âœ… Enable or disable the submit button
    function checkSelections() {
        const sizeSelected = form.querySelector('input[name="sizeID"]:checked');
        const colorSelected = form.querySelector('input[name="productID"]:checked');
        submitBtn.disabled = !(sizeSelected && colorSelected);
    }

    // ðŸ§  Listen for changes
    productRadios.forEach(radio => {
        radio.addEventListener('change', () => {
            updateActive(productRadios);
            updateVariantSelection();
            checkSelections();
        });
    });

    sizeRadios.forEach(radio => {
        radio.addEventListener('change', () => {
            updateActive(sizeRadios);
            checkSelections();
        });
    });

    // âœ… Initial check after DOM is ready
    updateActive(productRadios);
    updateActive(sizeRadios);
    updateVariantSelection();
    checkSelections();
});
</script>

{% endblock %}